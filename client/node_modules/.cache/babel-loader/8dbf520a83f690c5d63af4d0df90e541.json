{"ast":null,"code":"'use strict';\n\nconst MongoError = require('./error').MongoError;\n\nlet TxnState;\nlet stateMachine;\n\n(() => {\n  const NO_TRANSACTION = 'NO_TRANSACTION';\n  const STARTING_TRANSACTION = 'STARTING_TRANSACTION';\n  const TRANSACTION_IN_PROGRESS = 'TRANSACTION_IN_PROGRESS';\n  const TRANSACTION_COMMITTED = 'TRANSACTION_COMMITTED';\n  const TRANSACTION_COMMITTED_EMPTY = 'TRANSACTION_COMMITTED_EMPTY';\n  const TRANSACTION_ABORTED = 'TRANSACTION_ABORTED';\n  TxnState = {\n    NO_TRANSACTION,\n    STARTING_TRANSACTION,\n    TRANSACTION_IN_PROGRESS,\n    TRANSACTION_COMMITTED,\n    TRANSACTION_COMMITTED_EMPTY,\n    TRANSACTION_ABORTED\n  };\n  stateMachine = {\n    [NO_TRANSACTION]: [NO_TRANSACTION, STARTING_TRANSACTION],\n    [STARTING_TRANSACTION]: [TRANSACTION_IN_PROGRESS, TRANSACTION_COMMITTED, TRANSACTION_COMMITTED_EMPTY, TRANSACTION_ABORTED],\n    [TRANSACTION_IN_PROGRESS]: [TRANSACTION_IN_PROGRESS, TRANSACTION_COMMITTED, TRANSACTION_ABORTED],\n    [TRANSACTION_COMMITTED]: [TRANSACTION_COMMITTED, TRANSACTION_COMMITTED_EMPTY, STARTING_TRANSACTION, NO_TRANSACTION],\n    [TRANSACTION_ABORTED]: [STARTING_TRANSACTION, NO_TRANSACTION],\n    [TRANSACTION_COMMITTED_EMPTY]: [TRANSACTION_COMMITTED_EMPTY, NO_TRANSACTION]\n  };\n})();\n/**\r\n * The MongoDB ReadConcern, which allows for control of the consistency and isolation properties\r\n * of the data read from replica sets and replica set shards.\r\n * @typedef {Object} ReadConcern\r\n * @property {'local'|'available'|'majority'|'linearizable'|'snapshot'} level The readConcern Level\r\n * @see https://docs.mongodb.com/manual/reference/read-concern/\r\n */\n\n/**\r\n * A MongoDB WriteConcern, which describes the level of acknowledgement\r\n * requested from MongoDB for write operations.\r\n * @typedef {Object} WriteConcern\r\n * @property {number|'majority'|string} [w=1] requests acknowledgement that the write operation has\r\n * propagated to a specified number of mongod hosts\r\n * @property {boolean} [j=false] requests acknowledgement from MongoDB that the write operation has\r\n * been written to the journal\r\n * @property {number} [wtimeout] a time limit, in milliseconds, for the write concern\r\n * @see https://docs.mongodb.com/manual/reference/write-concern/\r\n */\n\n/**\r\n * Configuration options for a transaction.\r\n * @typedef {Object} TransactionOptions\r\n * @property {ReadConcern} [readConcern] A default read concern for commands in this transaction\r\n * @property {WriteConcern} [writeConcern] A default writeConcern for commands in this transaction\r\n * @property {ReadPreference} [readPreference] A default read preference for commands in this transaction\r\n */\n\n/**\r\n * A class maintaining state related to a server transaction. Internal Only\r\n * @ignore\r\n */\n\n\nclass Transaction {\n  /**\r\n   * Create a transaction\r\n   *\r\n   * @ignore\r\n   * @param {TransactionOptions} [options] Optional settings\r\n   */\n  constructor(options) {\n    options = options || {};\n    this.state = TxnState.NO_TRANSACTION;\n    this.options = {};\n\n    if (options.writeConcern || typeof options.w !== 'undefined') {\n      const w = options.writeConcern ? options.writeConcern.w : options.w;\n\n      if (w <= 0) {\n        throw new MongoError('Transactions do not support unacknowledged write concern');\n      }\n\n      this.options.writeConcern = options.writeConcern ? options.writeConcern : {\n        w: options.w\n      };\n    }\n\n    if (options.readConcern) this.options.readConcern = options.readConcern;\n    if (options.readPreference) this.options.readPreference = options.readPreference;\n    if (options.maxCommitTimeMS) this.options.maxTimeMS = options.maxCommitTimeMS; // TODO: This isn't technically necessary\n\n    this._pinnedServer = undefined;\n    this._recoveryToken = undefined;\n  }\n\n  get server() {\n    return this._pinnedServer;\n  }\n\n  get recoveryToken() {\n    return this._recoveryToken;\n  }\n\n  get isPinned() {\n    return !!this.server;\n  }\n  /**\r\n   * @ignore\r\n   * @return Whether this session is presently in a transaction\r\n   */\n\n\n  get isActive() {\n    return [TxnState.STARTING_TRANSACTION, TxnState.TRANSACTION_IN_PROGRESS].indexOf(this.state) !== -1;\n  }\n  /**\r\n   * Transition the transaction in the state machine\r\n   * @ignore\r\n   * @param {TxnState} state The new state to transition to\r\n   */\n\n\n  transition(nextState) {\n    const nextStates = stateMachine[this.state];\n\n    if (nextStates && nextStates.indexOf(nextState) !== -1) {\n      this.state = nextState;\n\n      if (this.state === TxnState.NO_TRANSACTION || this.state === TxnState.STARTING_TRANSACTION) {\n        this.unpinServer();\n      }\n\n      return;\n    }\n\n    throw new MongoError(`Attempted illegal state transition from [${this.state}] to [${nextState}]`);\n  }\n\n  pinServer(server) {\n    if (this.isActive) {\n      this._pinnedServer = server;\n    }\n  }\n\n  unpinServer() {\n    this._pinnedServer = undefined;\n  }\n\n}\n\nfunction isTransactionCommand(command) {\n  return !!(command.commitTransaction || command.abortTransaction);\n}\n\nmodule.exports = {\n  TxnState,\n  Transaction,\n  isTransactionCommand\n};","map":{"version":3,"sources":["C:/Users/mehta/daydream/node_modules/mongodb/lib/core/transactions.js"],"names":["MongoError","require","TxnState","stateMachine","NO_TRANSACTION","STARTING_TRANSACTION","TRANSACTION_IN_PROGRESS","TRANSACTION_COMMITTED","TRANSACTION_COMMITTED_EMPTY","TRANSACTION_ABORTED","Transaction","constructor","options","state","writeConcern","w","readConcern","readPreference","maxCommitTimeMS","maxTimeMS","_pinnedServer","undefined","_recoveryToken","server","recoveryToken","isPinned","isActive","indexOf","transition","nextState","nextStates","unpinServer","pinServer","isTransactionCommand","command","commitTransaction","abortTransaction","module","exports"],"mappings":"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","sourcesContent":["'use strict';\r\nconst MongoError = require('./error').MongoError;\r\n\r\nlet TxnState;\r\nlet stateMachine;\r\n\r\n(() => {\r\n  const NO_TRANSACTION = 'NO_TRANSACTION';\r\n  const STARTING_TRANSACTION = 'STARTING_TRANSACTION';\r\n  const TRANSACTION_IN_PROGRESS = 'TRANSACTION_IN_PROGRESS';\r\n  const TRANSACTION_COMMITTED = 'TRANSACTION_COMMITTED';\r\n  const TRANSACTION_COMMITTED_EMPTY = 'TRANSACTION_COMMITTED_EMPTY';\r\n  const TRANSACTION_ABORTED = 'TRANSACTION_ABORTED';\r\n\r\n  TxnState = {\r\n    NO_TRANSACTION,\r\n    STARTING_TRANSACTION,\r\n    TRANSACTION_IN_PROGRESS,\r\n    TRANSACTION_COMMITTED,\r\n    TRANSACTION_COMMITTED_EMPTY,\r\n    TRANSACTION_ABORTED\r\n  };\r\n\r\n  stateMachine = {\r\n    [NO_TRANSACTION]: [NO_TRANSACTION, STARTING_TRANSACTION],\r\n    [STARTING_TRANSACTION]: [\r\n      TRANSACTION_IN_PROGRESS,\r\n      TRANSACTION_COMMITTED,\r\n      TRANSACTION_COMMITTED_EMPTY,\r\n      TRANSACTION_ABORTED\r\n    ],\r\n    [TRANSACTION_IN_PROGRESS]: [\r\n      TRANSACTION_IN_PROGRESS,\r\n      TRANSACTION_COMMITTED,\r\n      TRANSACTION_ABORTED\r\n    ],\r\n    [TRANSACTION_COMMITTED]: [\r\n      TRANSACTION_COMMITTED,\r\n      TRANSACTION_COMMITTED_EMPTY,\r\n      STARTING_TRANSACTION,\r\n      NO_TRANSACTION\r\n    ],\r\n    [TRANSACTION_ABORTED]: [STARTING_TRANSACTION, NO_TRANSACTION],\r\n    [TRANSACTION_COMMITTED_EMPTY]: [TRANSACTION_COMMITTED_EMPTY, NO_TRANSACTION]\r\n  };\r\n})();\r\n\r\n/**\r\n * The MongoDB ReadConcern, which allows for control of the consistency and isolation properties\r\n * of the data read from replica sets and replica set shards.\r\n * @typedef {Object} ReadConcern\r\n * @property {'local'|'available'|'majority'|'linearizable'|'snapshot'} level The readConcern Level\r\n * @see https://docs.mongodb.com/manual/reference/read-concern/\r\n */\r\n\r\n/**\r\n * A MongoDB WriteConcern, which describes the level of acknowledgement\r\n * requested from MongoDB for write operations.\r\n * @typedef {Object} WriteConcern\r\n * @property {number|'majority'|string} [w=1] requests acknowledgement that the write operation has\r\n * propagated to a specified number of mongod hosts\r\n * @property {boolean} [j=false] requests acknowledgement from MongoDB that the write operation has\r\n * been written to the journal\r\n * @property {number} [wtimeout] a time limit, in milliseconds, for the write concern\r\n * @see https://docs.mongodb.com/manual/reference/write-concern/\r\n */\r\n\r\n/**\r\n * Configuration options for a transaction.\r\n * @typedef {Object} TransactionOptions\r\n * @property {ReadConcern} [readConcern] A default read concern for commands in this transaction\r\n * @property {WriteConcern} [writeConcern] A default writeConcern for commands in this transaction\r\n * @property {ReadPreference} [readPreference] A default read preference for commands in this transaction\r\n */\r\n\r\n/**\r\n * A class maintaining state related to a server transaction. Internal Only\r\n * @ignore\r\n */\r\nclass Transaction {\r\n  /**\r\n   * Create a transaction\r\n   *\r\n   * @ignore\r\n   * @param {TransactionOptions} [options] Optional settings\r\n   */\r\n  constructor(options) {\r\n    options = options || {};\r\n\r\n    this.state = TxnState.NO_TRANSACTION;\r\n    this.options = {};\r\n\r\n    if (options.writeConcern || typeof options.w !== 'undefined') {\r\n      const w = options.writeConcern ? options.writeConcern.w : options.w;\r\n      if (w <= 0) {\r\n        throw new MongoError('Transactions do not support unacknowledged write concern');\r\n      }\r\n\r\n      this.options.writeConcern = options.writeConcern ? options.writeConcern : { w: options.w };\r\n    }\r\n\r\n    if (options.readConcern) this.options.readConcern = options.readConcern;\r\n    if (options.readPreference) this.options.readPreference = options.readPreference;\r\n    if (options.maxCommitTimeMS) this.options.maxTimeMS = options.maxCommitTimeMS;\r\n\r\n    // TODO: This isn't technically necessary\r\n    this._pinnedServer = undefined;\r\n    this._recoveryToken = undefined;\r\n  }\r\n\r\n  get server() {\r\n    return this._pinnedServer;\r\n  }\r\n\r\n  get recoveryToken() {\r\n    return this._recoveryToken;\r\n  }\r\n\r\n  get isPinned() {\r\n    return !!this.server;\r\n  }\r\n\r\n  /**\r\n   * @ignore\r\n   * @return Whether this session is presently in a transaction\r\n   */\r\n  get isActive() {\r\n    return (\r\n      [TxnState.STARTING_TRANSACTION, TxnState.TRANSACTION_IN_PROGRESS].indexOf(this.state) !== -1\r\n    );\r\n  }\r\n\r\n  /**\r\n   * Transition the transaction in the state machine\r\n   * @ignore\r\n   * @param {TxnState} state The new state to transition to\r\n   */\r\n  transition(nextState) {\r\n    const nextStates = stateMachine[this.state];\r\n    if (nextStates && nextStates.indexOf(nextState) !== -1) {\r\n      this.state = nextState;\r\n      if (this.state === TxnState.NO_TRANSACTION || this.state === TxnState.STARTING_TRANSACTION) {\r\n        this.unpinServer();\r\n      }\r\n      return;\r\n    }\r\n\r\n    throw new MongoError(\r\n      `Attempted illegal state transition from [${this.state}] to [${nextState}]`\r\n    );\r\n  }\r\n\r\n  pinServer(server) {\r\n    if (this.isActive) {\r\n      this._pinnedServer = server;\r\n    }\r\n  }\r\n\r\n  unpinServer() {\r\n    this._pinnedServer = undefined;\r\n  }\r\n}\r\n\r\nfunction isTransactionCommand(command) {\r\n  return !!(command.commitTransaction || command.abortTransaction);\r\n}\r\n\r\nmodule.exports = { TxnState, Transaction, isTransactionCommand };\r\n"]},"metadata":{},"sourceType":"script"}