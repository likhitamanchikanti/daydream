{"ast":null,"code":"'use strict';\n\nconst OperationBase = require('./operation').OperationBase;\n\nconst applyRetryableWrites = require('../utils').applyRetryableWrites;\n\nconst applyWriteConcern = require('../utils').applyWriteConcern;\n\nconst decorateWithCollation = require('../utils').decorateWithCollation;\n\nconst executeCommand = require('./db_ops').executeCommand;\n\nconst formattedOrderClause = require('../utils').formattedOrderClause;\n\nconst handleCallback = require('../utils').handleCallback;\n\nconst ReadPreference = require('../core').ReadPreference;\n\nclass FindAndModifyOperation extends OperationBase {\n  constructor(collection, query, sort, doc, options) {\n    super(options);\n    this.collection = collection;\n    this.query = query;\n    this.sort = sort;\n    this.doc = doc;\n  }\n\n  execute(callback) {\n    const coll = this.collection;\n    const query = this.query;\n    const sort = formattedOrderClause(this.sort);\n    const doc = this.doc;\n    let options = this.options; // Create findAndModify command object\n\n    const queryObject = {\n      findAndModify: coll.collectionName,\n      query: query\n    };\n\n    if (sort) {\n      queryObject.sort = sort;\n    }\n\n    queryObject.new = options.new ? true : false;\n    queryObject.remove = options.remove ? true : false;\n    queryObject.upsert = options.upsert ? true : false;\n    const projection = options.projection || options.fields;\n\n    if (projection) {\n      queryObject.fields = projection;\n    }\n\n    if (options.arrayFilters) {\n      queryObject.arrayFilters = options.arrayFilters;\n    }\n\n    if (doc && !options.remove) {\n      queryObject.update = doc;\n    }\n\n    if (options.maxTimeMS) queryObject.maxTimeMS = options.maxTimeMS; // Either use override on the function, or go back to default on either the collection\n    // level or db\n\n    options.serializeFunctions = options.serializeFunctions || coll.s.serializeFunctions; // No check on the documents\n\n    options.checkKeys = false; // Final options for retryable writes and write concern\n\n    options = applyRetryableWrites(options, coll.s.db);\n    options = applyWriteConcern(options, {\n      db: coll.s.db,\n      collection: coll\n    }, options); // Decorate the findAndModify command with the write Concern\n\n    if (options.writeConcern) {\n      queryObject.writeConcern = options.writeConcern;\n    } // Have we specified bypassDocumentValidation\n\n\n    if (options.bypassDocumentValidation === true) {\n      queryObject.bypassDocumentValidation = options.bypassDocumentValidation;\n    }\n\n    options.readPreference = ReadPreference.primary; // Have we specified collation\n\n    try {\n      decorateWithCollation(queryObject, coll, options);\n    } catch (err) {\n      return callback(err, null);\n    } // Execute the command\n\n\n    executeCommand(coll.s.db, queryObject, options, (err, result) => {\n      if (err) return handleCallback(callback, err, null);\n      return handleCallback(callback, null, result);\n    });\n  }\n\n}\n\nmodule.exports = FindAndModifyOperation;","map":{"version":3,"sources":["C:/Users/mehta/daydream/node_modules/mongodb/lib/operations/find_and_modify.js"],"names":["OperationBase","require","applyRetryableWrites","applyWriteConcern","decorateWithCollation","executeCommand","formattedOrderClause","handleCallback","ReadPreference","FindAndModifyOperation","constructor","collection","query","sort","doc","options","execute","callback","coll","queryObject","findAndModify","collectionName","new","remove","upsert","projection","fields","arrayFilters","update","maxTimeMS","serializeFunctions","s","checkKeys","db","writeConcern","bypassDocumentValidation","readPreference","primary","err","result","module","exports"],"mappings":"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","sourcesContent":["'use strict';\r\n\r\nconst OperationBase = require('./operation').OperationBase;\r\nconst applyRetryableWrites = require('../utils').applyRetryableWrites;\r\nconst applyWriteConcern = require('../utils').applyWriteConcern;\r\nconst decorateWithCollation = require('../utils').decorateWithCollation;\r\nconst executeCommand = require('./db_ops').executeCommand;\r\nconst formattedOrderClause = require('../utils').formattedOrderClause;\r\nconst handleCallback = require('../utils').handleCallback;\r\nconst ReadPreference = require('../core').ReadPreference;\r\n\r\nclass FindAndModifyOperation extends OperationBase {\r\n  constructor(collection, query, sort, doc, options) {\r\n    super(options);\r\n\r\n    this.collection = collection;\r\n    this.query = query;\r\n    this.sort = sort;\r\n    this.doc = doc;\r\n  }\r\n\r\n  execute(callback) {\r\n    const coll = this.collection;\r\n    const query = this.query;\r\n    const sort = formattedOrderClause(this.sort);\r\n    const doc = this.doc;\r\n    let options = this.options;\r\n\r\n    // Create findAndModify command object\r\n    const queryObject = {\r\n      findAndModify: coll.collectionName,\r\n      query: query\r\n    };\r\n\r\n    if (sort) {\r\n      queryObject.sort = sort;\r\n    }\r\n\r\n    queryObject.new = options.new ? true : false;\r\n    queryObject.remove = options.remove ? true : false;\r\n    queryObject.upsert = options.upsert ? true : false;\r\n\r\n    const projection = options.projection || options.fields;\r\n\r\n    if (projection) {\r\n      queryObject.fields = projection;\r\n    }\r\n\r\n    if (options.arrayFilters) {\r\n      queryObject.arrayFilters = options.arrayFilters;\r\n    }\r\n\r\n    if (doc && !options.remove) {\r\n      queryObject.update = doc;\r\n    }\r\n\r\n    if (options.maxTimeMS) queryObject.maxTimeMS = options.maxTimeMS;\r\n\r\n    // Either use override on the function, or go back to default on either the collection\r\n    // level or db\r\n    options.serializeFunctions = options.serializeFunctions || coll.s.serializeFunctions;\r\n\r\n    // No check on the documents\r\n    options.checkKeys = false;\r\n\r\n    // Final options for retryable writes and write concern\r\n    options = applyRetryableWrites(options, coll.s.db);\r\n    options = applyWriteConcern(options, { db: coll.s.db, collection: coll }, options);\r\n\r\n    // Decorate the findAndModify command with the write Concern\r\n    if (options.writeConcern) {\r\n      queryObject.writeConcern = options.writeConcern;\r\n    }\r\n\r\n    // Have we specified bypassDocumentValidation\r\n    if (options.bypassDocumentValidation === true) {\r\n      queryObject.bypassDocumentValidation = options.bypassDocumentValidation;\r\n    }\r\n\r\n    options.readPreference = ReadPreference.primary;\r\n\r\n    // Have we specified collation\r\n    try {\r\n      decorateWithCollation(queryObject, coll, options);\r\n    } catch (err) {\r\n      return callback(err, null);\r\n    }\r\n\r\n    // Execute the command\r\n    executeCommand(coll.s.db, queryObject, options, (err, result) => {\r\n      if (err) return handleCallback(callback, err, null);\r\n\r\n      return handleCallback(callback, null, result);\r\n    });\r\n  }\r\n}\r\n\r\nmodule.exports = FindAndModifyOperation;\r\n"]},"metadata":{},"sourceType":"script"}